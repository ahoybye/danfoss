<apex:page showHeader="false" sidebar="false" standardStylesheets="false" docType="html-5.0" controller="BMCServiceDesk.DeepViewController" expires="5">
    <title>{!$Label.DeepView}</title>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link rel="stylesheet" href="{!URLFOR($Resource.DeepView, '/styles/bootstrap.css')}"/>
    <link rel="stylesheet" href="{!URLFOR($Resource.DeepView, '/DPLFramework/css/bmc-all.css')}"/>
    <link rel="stylesheet" href="{!$Resource.Salesforce1}/SelfService/css/rfmodal.css"/>
    <link rel="stylesheet" href="{!URLFOR($Resource.DeepView, '/styles/DeepView.css')}"/>
    <!--[if IE]>
        <link rel="stylesheet" type="text/css" href="{!URLFOR($Resource.DeepView, '/styles/ie-only.css')}"/>
    <![endif]-->
    <!-- Setting override for Lightning Pages -->
    <apex:outputPanel rendered="{!$User.UITheme == 'Theme4d'}">
        <link rel="stylesheet" href="{!URLFOR($Resource.DeepView, '/styles/lightningOverride.css')}"/> <!-- style override -->
    </apex:outputPanel>
    
    <script>
        var pageLoadData = JSON.parse('{!pageLoadData}');
        var imagePath = '{!URLFOR($Resource.DeepView)}/styles/images';
        var isTemplateEnabled = {!isTemplateEnabled};
    </script>
    
    <body id="appPanel">
        <div data-ng-controller="DeepViewController" data-ng-init="DeepViewController()" class="container">
            <div ng-include="'{!$Resource.DeepView}/templates/Loader.html'"/>
            <div class="dialog-backgray" ng-if="showAttachFile || showAddNote || showSendEmail || showServiceTarget || saveImage || showApprovals || showNotification" ng-click="hidePanels()"/>
            <div id="modalContent" class="white-background"></div>
            <div class="pagewrapper">
                <div ng-include="'{!$Resource.DeepView}/templates/PageHeader.html'" class="header-panel"/>
                <div class="canvaswrapper">
                    <aside class="white-background" style="canvas-graph-container">
                        <div class="graph-zoomer" align="center">                           
                            <canvas id="zoomWidget" width="40" height="300"></canvas>
                            <span ng-include="'{!$Resource.DeepView}/templates/Legends.html'"/>
                        </div>
                        <div class="canvas-container centerAlign">
                            <canvas id="diagram"/>
                        </div>
                    </aside>
            
                    <div class="quick-details-panel hide" id="quickDetailsPanel">
                        <div class="quick-details-headerBtnPanel" >
                            <span class="btn-panel-quickdetail">
                                <button class='__icon-right-pencil' ng-click="enableEdit()" title="{{_Labels.quickDetails.edit}}" ng-show="!enableQuickEdit"></button>
                                <button class='__icon-check' ng-click="saveRecord()" title="{{_Labels.quickDetails.save}}" ng-show="enableQuickEdit"></button>
                                <button class='__icon-left-reply' ng-click="cancelEdit()" title="{{_Labels.quickDetails.cancel}}" ng-show="enableQuickEdit"></button>
                            </span>
                            <span class="separator quickdetail"></span>
                            <button class="btn-service-target {{isServiceEnabled ? 'enabled' : 'disabled'}}" ng-click="queryServiceTargets(isServiceEnabled, true)" title="{{_Labels.quickDetails.serviceTarget}}">{{_Labels.quickDetails.serviceTarget}}</button>
                        </div>  
                        <div class="quick-view-container" id="quickViewContainer">                      
                            <table class="quickView" >                     
                                <tbody ng-repeat="node in nodeKeys track by $index" ng-if="node != 'attributes' && node != 'Attachments' && node != 'Histories' && node.indexOf('__r') < 0">
                                    <tr ng-if="fieldMetaData[node] != undefined && fieldMetaData[node] != '' && fieldMetaData[node]['fldLabel'] != undefined && fieldMetaData[node]['fldLabel'] != null">                                   
                                        <!-- Laebl Column -->
                                        <td class="quickview-table-label">
                                            <h6 class="question-label" style="margin: 0;color: #666;">{{fieldMetaData[node]['fldLabel']}}</h6>
                                        </td>                                   
                                        <!-- Detail Column -->
                                        <td colspan="2">
                                            <!-- Read-only Panel -->
                                            <span ng-if="!fieldMetaData[node].isWritable || !enableQuickEdit" style="width:100%;display: inline-block;">
                                                <span ng-if="fieldMetaData[node]['fieldType'] == 'BOOLEAN'" ng-class="rootData[node] ? '__icon-check' : '__icon-cross'" style="height: 15px;width:15px"/>
                                                <span ng-if="fieldMetaData[node]['fieldType'] != 'DATETIME' && fieldMetaData[node]['fieldType'] != 'BOOLEAN'" style="width:94%;display: inline-block;;">
                                                    {{fieldMetaData[node]['fieldType'] == 'REFERENCE' || fieldMetaData[node]['fieldType'] == 'REF-PICKLIST'  
                                                      ? node == 'OwnerId' ? rootData['Owner'].Name : rootData[node.replace('__c', '__r')].Name 
                                                      : rootData[node]}}
                                                </span>
                                                <span ng-if="fieldMetaData[node]['fieldType'] == 'DATETIME'">{{rootData[node] | date:"MM/dd/yyyy ' ' h:mma"}}</span>
                                            </span>
                                            
                                            <!-- Edit Panel begins -->
                                            <span ng-if="fieldMetaData[node].isWritable && enableQuickEdit">
                                                <!-- RED BARS INDICATING REQUIRED FIELDS -->
                                                <span class="required-input text" ng-if="fieldMetaData[node].isRequired != undefined && fieldMetaData[node].isRequired && fieldMetaData[node]['fieldType'] != 'TEXTAREA'"></span>
                                                <span class="required-input" ng-if="fieldMetaData[node].isRequired != undefined && fieldMetaData[node].isRequired && fieldMetaData[node]['fieldType'] == 'TEXTAREA'" style="height:84px;"></span>
                                                
                                                <!-- PCIKLIST CREATED FROM RECORDS - IMPACT/URGENCY -->
                                                <select ng-options="item.Id as item.Name for item in fieldMetaData[node]['defaultValues']"  
                                                        ng-model="fieldMetaData[node].fvalue" 
                                                        ng-if="enableQuickEdit && fieldMetaData[node]['fieldType'] == 'REF-PICKLIST'" 
                                                        class="quick-edit"
                                                        ng-init="fieldMetaData[node].fvalue = rootData[node]"
                                                        reqd="{{fieldMetaData[node].isRequired}}"/>
                                                
                                                <!-- PCIKLIST CREATED FROM PICKLIST TYPE FIELDS -->
                                                <select ng-options="item as item for item in fieldMetaData[node]['defaultValues']"  
                                                        ng-model="fieldMetaData[node].fvalue" 
                                                        ng-if="enableQuickEdit && fieldMetaData[node]['fieldType'] == 'PICKLIST'" 
                                                        class="quick-edit"
                                                        ng-init="fieldMetaData[node].fvalue = rootData[node]"
                                                        reqd="{{fieldMetaData[node].isRequired}}"/>
                                                        
                                                <!-- LOOKUP INPUT -->
                                                <input type="{{fieldMetaData[node]['fieldType']}}" 
                                                       class="quick-edit" 
                                                       style="width: 90%; display: inline-block;" 
                                                       ng-click="getlookup(node, fieldMetaData[node]['referenceTo'])" 
                                                       mg-model="fieldMetaData[node]" 
                                                       value="{{fieldMetaData[node].fRefFieldVal}}"
                                                       ng-if="(fieldMetaData[node]['fieldType'] == 'REFERENCE') && (((fieldMetaData[node]['referenceTo'].indexOf('SYSTemplate__c')) > -1 && isTemplateEnabled) || ((fieldMetaData[node]['referenceTo'].indexOf('SYSTemplate__c')) == -1))"
                                                       ng-init="fieldMetaData[node].fRefFieldVal = node == 'OwnerId' ? rootData['Owner'].Name : rootData[node.replace('__c', '__r')].Name; 
                                                                fieldMetaData[node].fvalue = node == 'OwnerId' ? rootData[node] : rootData[node]"
                                                       reqd="{{fieldMetaData[node].isRequired}}" readonly="readonly"/>
                                               
                                                <!-- DATE-TIME INPUTS -->
                                                <input ng-if="fieldMetaData[node]['fieldType'] == 'DATETIME'" type="datetime-local" ng-model="fieldMetaData[node].fvalue" class="quick-edit"
                                                       ng-init="fieldMetaData[node].fvalue = parseDate(rootData[node])" reqd="{{fieldMetaData[node].isRequired}}"/>
                                                
                                                <!-- BOOLEAN INPUTS -->
                                                <input ng-if="fieldMetaData[node]['fieldType'] == 'BOOLEAN'" type="checkbox" ng-model="fieldMetaData[node].fvalue" class="quick-edit" style="width:inherit; vertical-align: middle;"
                                                       ng-init="fieldMetaData[node].fvalue = rootData[node]" reqd="{{fieldMetaData[node].isRequired}}"/>
                                                
                                                <!-- TEXT AREA INPUTS -->
                                                <textarea ng-if="fieldMetaData[node]['fieldType'] == 'TEXTAREA'" ng-model="fieldMetaData[node].fvalue" class="quick-edit" style="padding:0px" 
                                                          ng-init="fieldMetaData[node].fvalue = rootData[node]" reqd="{{fieldMetaData[node].isRequired}}"/>
                                            </span>
                                            <!-- Edit Panel ends -->
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            <div ng-include="'{!$Resource.DeepView}/templates/QuickDetailsRelatedList.html'"/>
                        </div>  
                    </div>
                </div>
            </div>  
        </div>  
        
        <script type="text/javascript">MindFusionImpl = "JQuery";</script>
        <script type="text/javascript" src="{!$Resource.Salesforce1}/js/jquery-1.9.1.min.js"/>
        <script type="text/javascript" src="{!$Resource.CustomerExperience}/js/jquery-ui.js"/>
        <script type="text/javascript" src="{!$Resource.Salesforce1}/SelfService/DPLLibraries/js/libs/angular/angular-1.3.15.js"/>
        <script type="text/javascript" src="{!$Resource.Salesforce1}/SelfService/DPLLibraries/js/libs/angular/plugins/angular-sanitize.js"/>
        <script type="text/javascript" src="{!$Resource.DeepView}/js/MindFusion.Common.js"/>
        <script type="text/javascript" src="{!$Resource.DeepView}/js/MindFusion.Diagramming.js"/>
        <script type="text/javascript" src="{!$Resource.DeepView}/js/jquery.dplAccordion.js"/>
        <script type="text/javascript" src="{!$Resource.DeepView}/js/rfmodal.js"/>
        <script type="text/javascript" src="{!$Resource.DeepView}/js/bootstrap.js"/>
        <script type="text/javascript">var __sfdcSessionId = '{!GETSESSIONID()}';</script>
        <script src="/soap/ajax/34.0/connection.js" type="text/javascript"></script>

        <script type="text/javascript">
        var ObjectLabels = {
            "singular": {
                "BMC_BaseElement__c": "CMDB",
                "Incident__c": "{!$ObjectType['Incident__c'].label}",
                "Change_Request__c": "{!$ObjectType['Change_Request__c'].label}",
                "Release__c": "{!$ObjectType['Release__c'].label}",
                "Problem__c": "{!$ObjectType['Problem__c'].label}",
                "Task__c": "{!$ObjectType['Task__c'].label}",
                "Service_Request__c": "{!JSENCODE($Label.SSHelpRequest)}"
            },
            "plural": {
                "BMC_BaseElement__c": "CMDBs",
                "Incident__c": "{!$ObjectType['Incident__c'].labelPlural}",
                "Change_Request__c": "{!$ObjectType['Change_Request__c'].labelPlural}",
                "Release__c": "{!$ObjectType['Release__c'].labelPlural}",
                "Problem__c": "{!$ObjectType['Problem__c'].labelPlural}",
                "Task__c": "{!$ObjectType['Task__c'].labelPlural}",
                "Service_Request__c": "{!JSENCODE($Label.SSMyHelpRequests)}"
            }
        };
        
        var deepViewResourceURL = '{!$Resource.DeepView}';
        var userTimeZone='{!userTimeZone}';
        var _RemotingActions = {
            "getLookUpData"   : "{!$RemoteAction.DeepViewController.getLookupData}",
            "queryAllData"    : "{!$RemoteAction.DeepViewController.queryAllData}",
            "getBroadcastMsgs": "{!$RemoteAction.DeepViewController.getBroadcastMsgs}",
            "searchUser"      : "{!$RemoteAction.DeepViewController.searchUser}",
            "getServiceTarget": "{!$RemoteAction.DeepViewController.getServiceTarget}",
            "saveRecord"      : "{!$RemoteAction.DeepViewController.saveRecord}",
            "sendEmail"       : "{!$RemoteAction.DeepViewController.sendEmailToReceps}",
            "saveNotes"       : "{!$RemoteAction.DeepViewController.saveNotes}",
            "queryRecord"     : "{!$RemoteAction.DeepViewController.queryRecord}",
            "getActivity"     : "{!$RemoteAction.DeepViewController.getActivity}",
            "getApprovals"    : "{!$RemoteAction.DeepViewController.getApprovals}",
            "addAction"       : "{!$RemoteAction.DeepViewController.addAction}",
            "addAttachment"   : "{!$RemoteAction.DeepViewController.addAttachment}",
            "callApproveRejectRecall"   : "{!$RemoteAction.DeepViewController.callApproveORRejectORRecall}",
            "callReassign"   : "{!$RemoteAction.DeepViewController.callReassignRecord}",
            "getReassignApprover" : "{!$RemoteAction.DeepViewController.getReassignApproverMap}",
            "checkApprovalPermission": "{!$RemoteAction.DeepViewController.checkApprovalPermissions}",
            "checkAdminPermission":"{!$RemoteAction.DeepViewController.isAdminOrModifyAll}",
            "getAllStatusesAndStages"   : "{!$RemoteAction.DeepViewController.getAllStatusesAndStages}"
        }
        
        var _Labels={
            "search":"{!JSENCODE($Label.SearchFor)}",
            "ShowMore":"{!JSENCODE($Label.ShowMore)}",
            "recordsNotFound":"{!JSENCODE($Label.MsgNoRecordFoundSearchPage)}",
            "pageHeader":{
                "since":"{!JSENCODE($Label.Since)}",
                "assignedTo":"{!JSENCODE($Label.AssignedTo)}",
                "expandNode":"{!JSENCODE($Label.SetPrimaryNode)}",
                "export":"{!JSENCODE($Label.Export)}",
                "print":"{!JSENCODE($Label.Print)}",
                "recordDetails":"{!JSENCODE($Label.RelatedLists)}",
                "legend":"{!JSENCODE($Label.Legend)}",
                "record":"{!JSENCODE($Label.Record)}",
                "inProgress":"{!JSENCODE($Label.InProgress)}",
                "completed":"{!JSENCODE($Label.CompletedScan)}",
                "status":"{!JSENCODE($Label.Status)}",
                "stage":"{!JSENCODE($Label.StageValue)}",
                "opened":"{!JSENCODE($Label.Opened)}",
                "acknowledged":"{!JSENCODE($Label.StageProgression_Acknowledged)}",
                "inprocess":"{!JSENCODE($Label.StageProgression_InProcess)}",
                "closed":"{!JSENCODE($Label.Closed)}",
                "client":"{!JSENCODE($Label.ClientWindowHeaderSearchPage)}"
            },
            "quickDetails":{
                "recordDetails":"{!JSENCODE($Label.RelatedLists)}",
                "activityFeed":"{!JSENCODE($Label.ActivityFeed)}",
                "attachments":"{!JSENCODE($Label.Attachments)}",
                "fulfillment":"{!JSENCODE($Label.Fulfillment)}",
                "serviceTarget":"{!JSENCODE($Label.ServiceTarget)}",
                "showLess":"{!JSENCODE($Label.ShowLess)}",
                "showMore":"{!JSENCODE($Label.ShowMore)}",
                "addNotes":"{!JSENCODE($Label.Message1)}",
                "sendEmail":"{!JSENCODE($lABEL.SendEmail)}",
                "refresh":"{!JSENCODE($Label.Refresh)}",
                "addAttachment":"{!JSENCODE($Label.SSAddAttachment)}",
                "edit":"{!JSENCODE($Label.CMDBEdit)}",
                "save":"{!JSENCODE($Label.Save)}",
                "cancel":"{!JSENCODE($Label.Cancel)}"
            },
            "modal":{
                "serviceTarget":"{!JSENCODE($Label.ServiceTarget)}",
                "addNotes":"{!JSENCODE($Label.Message1)}",
                "sendEmail":"{!JSENCODE($lABEL.SendEmail)}",
                "attachment":"{!JSENCODE($Label.SSAddAttachment)}",
                "approvalHistory":"{!JSENCODE($Label.ApprovalHistory)}",
                "add":"{!JSENCODE($Label.Add)}",
                "to":"{!JSENCODE($Label.To)}",
                "cc":"{!JSENCODE($Label.Cc)}",
                "bcc":"{!JSENCODE($Label.Bcc)}",
                "subject":"{!JSENCODE($Label.SSContactUsSubject)}",
                "body":"{!JSENCODE($Label.BODY)}",
                "advancedMailHelpText":"{!JSENCODE($Label.AdvancedEmail)}",
                "clickHere":"{!JSENCODE($Label.ClickHerelbl)}",
                "send":"{!JSENCODE($Label.Send)}",
                "noServiceRequestFound":"{!JSENCODE($Label.MsgNoRecordFoundSearchPage)}",
                "approver":"{!JSENCODE($Label.Change_Approval_Approver)}",
                "status":"{!JSENCODE($Label.Status)}",
                "dateTime":"{!JSENCODE($Label.Change_Approval_Submitted_Date)}",
                "saveImageAs":"{!JSENCODE($Label.SaveImageAs)}",
                "approve":"{!JSENCODE($Label.Approve)}",
                "reject":"{!JSENCODE($Label.Reject)}",
                "reassign":"{!JSENCODE($Label.Reassign)}",
                "recall":"{!JSENCODE($Label.RecallApprovalRequest)}",
                "comment":"{!JSENCODE($Label.Comments)}",
                "approver":"{!JSENCODE($Label.SSApprovalApprover)}",
                "Approvals":"{!JSENCODE($Label.Approvals)}",
                "approvaldetails":"{!JSENCODE($Label.ApprovalDetails)}",
                "queue":"{!JSENCODE($Label.Queue)}",
                "user":"{!JSENCODE($Label.User)}",
                "save":"{!JSENCODE($Label.Save)}"
                
            },
            "message":{
                "recordClosedAlready":"{!JSENCODE($Label.RecordClosedAlready)}",
                "noActivityFound":"{!JSENCODE($Label.MsgNoRecordFoundSearchPage)}",
                "noAttachmentFound":"{!JSENCODE($Label.MsgNoRecordFoundSearchPage)}",
                "attachmentRequired":"{!JSENCODE($Label.AttachmentMandatory)}",
                "attachmentLimit":"{!JSENCODE($Label.AttachmentLimit)}",
                "fldsRequired":"{!JSENCODE($Label.RequiredFieldsEntry)}",
                "emailSent":"{!JSENCODE($Label.EmailSent)}",
                "invalidEmailAddress":"{!JSENCODE($Label.milestoneValidEmailAddr)}",
                "noteAdded":"{!JSENCODE($Label.NoteAdded)}",
                "noteCreationFailure":"{!JSENCODE($Label.NoteCreationFailed)}",
                "RecordSavedSuccessfuly":"{!JSENCODE($Label.RecordSavedSuccessfuly)}",
                "AttchmentAddedSuccessfuly":"{!JSENCODE($Label.AttchmentAddedSuccessfuly)}",
                "AttachmentCreateFailed":"{!JSENCODE($Label.AttachmentCreateFailed)}",
                "RecordUpdateFailed":"{!JSENCODE($Label.RecordUpdateFailed)}"
            },
			"serviceTargetStatus":{
                "OK":"{!JSENCODE($Label.ServiceTargetStatus_OK)}",
                "Cancelled":"{!JSENCODE($Label.ServiceTargetStatus_Cancelled)}",
                "Met":"{!JSENCODE($Label.ServiceTargetStatus_Met)}",
                "Missed":"{!JSENCODE($Label.ServiceTargetStatus_Missed)}",
                "Warning":"{!JSENCODE($Label.ServiceTargetStatus_Warning)}"
            }
        }
        </script>
		<apex:includeScript value="{!URLFOR($Resource.BMCServiceDesk__DeepView, '/js/moment/moment.min.js')}"/>  
		<apex:includeScript value="{!URLFOR($Resource.BMCServiceDesk__DeepView, '/js/moment/moment-timezone-with-data.min.js')}"/>
        <script type="text/javascript" src="{!$Resource.DeepView}/js/Configuration.js"/>
        <script type="text/javascript" src="{!$Resource.DeepView}/js/ng-DeepViewController.js"/>
        <script type="text/javascript" src="{!$Resource.DeepView}/js/GraphBuilder.js"/>
        <script>angular.bootstrap(document, ['DeepView']);</script>
        <div id="stageProgressBar" ng-show="showStages" class="stagedivCollapse" style="position: absolute; z-index: 10; left: 0px; top: 0px;"></div>
    </body>
</apex:page>