<apex:page id="thpage"  standardController="BMCServiceDesk__Change_Request__c" extensions="BMCServiceDesk.ConsoleChangeDetailController,BMCServiceDesk.ConsoleRemoteActions"  standardStylesheets="true" showHeader="false" sidebar="false" >
<head>
    <link rel="stylesheet" href="{!$Resource.SDEFStyles}/ConsoleDetail.css" type="text/css" />
    <script type="text/javascript" src="{!$Resource.SDEFCommonJS}/HTML_ENCODE_DECODE.js"></script>
</head>
  
<body onload="doOnLoadActivity()">
    <apex:form id="theForm"  onclick="parent.hideMenu();">
    <apex:actionFunction action="{!saveRecord}" name="save" rerender="messagePanel" oncomplete="stopWaitMsgBar();headerSpaceHandler();">
         <apex:param assignTo="{!queueName}" name="strQueueName" value=""/>
         <apex:param assignTo="{!lastModifiedByLocking}" name="lastModifiedByLocking" value=""/>
    </apex:actionFunction>
     <apex:actionFunction action="{!saveRecordWR}" name="saveWithRerender" rerender="messagePanel,frequentRereshPanel,genericPanel,renderPanel,tableOutputpanel" oncomplete="fillStaticValueAfterError();if(callback){callBackFunc();}else{stopWaitMsgBar();displayMessage();AddTextareaEditorButton();} if (saveSuccessful != null) window.parent.lockRecordAfterSave();headerSpaceHandler();">
     <apex:param assignTo="{!queueName}" name="strQueueName" value=""/>
     <apex:param assignTo="{!queueId}" name="queueIdElVal" value=""/>
     <apex:param assignTo="{!lastModifiedByLocking}" name="lastModifiedByLocking" value=""/>
     </apex:actionFunction>
     <apex:actionFunction action="{!callBackFuncForSharingRules}" name="callBackFunc"  reRender="messagePanel,frequentRereshPanel,genericPanel,renderPanel,tableOutputpanel" oncomplete="stopWaitMsgBar();displayMessage();AddTextareaEditorButton();fillStaticValueAfterError();"  immediate="true" />
     <apex:actionFunction action="{!applyTemplate}" name="applyTemplate" rerender="messagePanel, tableOutputpanel,frequentRereshPanel"  oncomplete="ChangeStateOfParentButtons(false);stopWaitMsgBar();AddTextareaEditorButton();RenderStatussection();" immediate="true">
     	<apex:param assignTo="{!templateId}" name="templateId" value=""/> 
     	<apex:param assignTo="{!initiatorName}" name="userNameVal" value=""/>
     	<apex:param assignTo="{!changeRequest.BMCServiceDesk__FKInitiator__c}" name="userIdVal" value=""/>
     	<apex:param assignTo="{!ownerName}" name="ownerElVal" value=""/>
     	<apex:param assignTo="{!staffName}" name="staffElVal" value=""/>
     	<apex:param assignTo="{!changeRequest.FKStaff__c}" name="staffIdVal" value=""/>
     	<apex:param assignTo="{!changeRequest.ownerid}" name="ownerIdVal" value=""/>
     	<apex:param assignTo="{!changeRequest.BMCServiceDesk__FKUrgency__c}" name="urgencyFieldVal" value=""/>
     	<apex:param assignTo="{!changeRequest.BMCServiceDesk__FKImpact__c}" name="impactFieldVal" value=""/>
     	<apex:param assignTo="{!changeRequest.BMCServiceDesk__FKStatus__c}" name="statusFieldVal" value=""/>
     	<apex:param assignTo="{!queueId}" name="queueIdElVal" value=""/>
     </apex:actionFunction> 
	<apex:actionFunction name="AssignAttRefGeneratorId" rerender="messagePanel" immediate="true">
     	<apex:param assignTo="{!attRefGeneratorId}" name="attRefGeneratorId" value=""/> 
     </apex:actionFunction>
    <apex:actionFunction name="rerenderCollisionMessage" rerender="collisionMessagePanel">
      </apex:actionFunction>
     <script>
	  window.parent.initialRecordState = '{!initialRecordState}';
    var lastModifiedByLocking = '{!JSENCODE(lastModifiedByLocking)}';
    var saveSuccessful = '';
      var NONPRINT = '¬';
      var ServiceId = '';
      var categoryName = '';
      var categoryId = '';
      var userTypeReference = '';
      var categoryLookupId = '';
      var urgencyLookupId = '';
	  var impactLookupId = '';
	  var statusLookupId = '';
	  var queue_Id = '';
	  var urgencyFieldVal = '';
	  var impactFieldVal = '';
	  var statusFieldVal = '';
	  var userName = '';
	  var userId = '';
	  var PE = 'П';
	  var orgNamespace = '{!orgNamespace}';
	  var lookupFilterIDMap = {};
      var readOnlyFieldMap = {};
      var filterFieldsMap= {};
      var pageSectionIdMap = {};
      var refType = 'reference';
      var noRefType = '';
      var typeAheadDivId = 'autocompleteDiv';
      var currentConsole = 'Change Request';
      var filterStr = {!filterAPIStr};
      var fieldApiName;
      var mandatoryFields = {};
	  var isAutocomplete = false;
	  var AssignmentDetailSection = '{!JSINHTMLENCODE($Label.Console_Assignment)}';
      var isAssignmentDetailSectionPresent = false;
      var Error = '{!JSENCODE($Label.Error)}';
      var isClientMandatory = false;
      var isCategoryMandatory = false;
      var ClientFieldName = 'FKInitiator__c';
      var lblClear = '{!JSENCODE($Label.Clear)}';
      var customStaffApi = 'FKStaff__c';
      var impactHelpText = '{!JSENCODE(impactTooltip)}';
      var urgencyHelpText = '{!JSENCODE(urgencyTooltip)}';
      var statusHelpText = '{!JSENCODE(statusTooltip)}';	  
      var firstElement = '';    
     var tagname = '';
     var callback={!callback};
	 var membersOf= '{!JSENCODE($Label.Members_of)}';

	  // Used to disabled the auto complete div.
	  function disableDiv(divId){
		if(!isAutocomplete){
		var divobj=document.getElementById(divId);
		if(divobj!=null && divobj!=undefined)
			divobj.style.visibility='hidden';
		}
	  }
	  function findClients(sel,divId,field,evt){
		if(typeof(findClientsJS) != 'undefined')
			findClientsJS(sel,divId,field,evt);
	  }
	  
	  function setFSFieldDetail(fieldAPIName, fieldLabel, ftype, fsRequired, fsDBRequired, fsName, fieldId, fieldHelpText,fieldUserLookup, fieldUpdateableFlag) {
        var objtitleval = document.getElementById(fieldId);
        if (objtitleval) { 
            var fieldValue = objtitleval.value; 
			if(objtitleval != null && objtitleval != 'undefined') objtitleval.title = fieldHelpText;
			
			if(lookupFilterIDMap[fieldAPIName]==null){
				lookupFilterIDMap[fieldAPIName] = fieldId;
			}
			if(fieldUpdateableFlag == false) {
				if(readOnlyFieldMap[fieldId]==null){
					var elemVal;
					if(ftype == 'textarea')
						elemVal = document.getElementById(fieldId).value;
					else if(ftype == 'string')
						elemVal = RemedyForceHTMLProcessor.getText(document.getElementById(fieldId));
							
                    readOnlyFieldMap[fieldId] =elemVal; 
				}
            }
			
			if ((fsRequired || fsDBRequired) || (fsName.toUpperCase()==('BMCServiceDesk__Console_Initiator_Details').toUpperCase() && fieldAPIName.indexOf('FKInitiator__c') > 0)
						|| (fsName.toUpperCase()==('BMCServiceDesk__Console_Change_Request_Details').toUpperCase() && fieldAPIName.indexOf('FKCategory__c') > 0 )) { 
				if (fieldAPIName.indexOf('FKImpact__c') > 0) 
					mandatoryFields['impactSelectId'] = fieldLabel + NONPRINT + fieldValue;
				else if (fieldAPIName.indexOf('FKUrgency__c') > 0) 
					mandatoryFields['urgencySelectId'] = fieldLabel + NONPRINT + fieldValue;
				else if (fieldAPIName.indexOf('FKStatus__c') > 0) 
					mandatoryFields['statusSelectId'] = fieldLabel + NONPRINT + fieldValue;
				else
					mandatoryFields[fieldId] = fieldLabel + NONPRINT + fieldValue;
			}
			
			if (fsName.toUpperCase()==('BMCServiceDesk__Console_Change_Request_Details').toUpperCase() && fieldAPIName.indexOf('FKCategory__c') > 0) {
				isCategoryMandatory = true;
				if(parent.Ext.isIE8 || parent.Ext.isIE7){
					objtitleval.style.marginRight="-4px"; 
				}
 
            }
            
            if (fsName.toUpperCase()==('BMCServiceDesk__Console_Initiator_Details').toUpperCase() && fieldAPIName.indexOf('FKInitiator__c') > 0 ) {
				
				isClientMandatory = true;
				if(parent.Ext.isIE8 || parent.Ext.isIE7){
					objtitleval.style.marginRight="-4px"; 
				}
 
            }
       }      
              
            tagname = objtitleval.tagName;
			if (firstElement == '' && tagname.toUpperCase() != 'SPAN') {
				if(fieldAPIName.toUpperCase() == (orgNamespace+'FKImpact__c').toUpperCase()){
					firstElement = 'impactSelectId';
				}else if( fieldAPIName.toUpperCase() == (orgNamespace+'FKUrgency__c').toUpperCase()){
					firstElement = 'urgencySelectId';
				}else if(fieldAPIName.toUpperCase() == (orgNamespace+'FKStatus__c').toUpperCase()){
					firstElement = 'statusSelectId';
				}
				else{
					firstElement = fieldId;
				}
			}
    }
	  
     </script>    
               <apex:outputPanel id="tableOutputpanel" layout="block" style="overflow:none;height:100%;width:100%">  

                    <apex:outputPanel id="collisionMessagePanel" styleClass="messageContainer" >     
	                  	<apex:pageMessage title="{!$Label.BMCServiceDesk__CollisionDetected}:" 
	                  			summary="{!$Label.BMCServiceDesk__CollisionDetectedSummary}" 
                                   severity="error" strength="2" rendered="{!AutoShowCollisionPopup}" id="collisionMessage"/>
                          
					</apex:outputPanel>
  
                  <apex:outputPanel id="messagePanel" styleClass="messageContainer">            
                    <apex:pageMessages id="pageMessage" />
                    <div id="jsscripterrorId" class="message errorM3" style="display:none">
						<table class="messageTable" cellspacing="0" cellpadding="0" border="0" style="padding: 0px; margin: 0px;">
							<tr valign="top">
								<td>
									<img class="msgIcon" title="{!JSENCODE($Label.Error)}" src="/s.gif" alt="{!JSENCODE($Label.Error)}" />
								</td>
								<td>
									<div id="errorDescId"  class="messageText"></div>
								</td>
							</tr>
						</table>
					</div> 
					<!-- Success Message -->
					<div id="jsscriptsucessmsg"  style="display:none">
					 <apex:pageMessage summary="{!$Label.BMCServiceDesk__ApprovalSuccessMsg}" severity="confirm" strength="3"/> 
					 </div>
					 <div id="SaveMessageDiv" class="msgCls message" style="display:none">
						<table class="messageTable" cellspacing="0" cellpadding="0" border="0" style="padding: 0px; margin: 4px 2px 4px 2px;">
							<tr valign="top">
								<td>
									<apex:image styleClass="SaveSuccessIcon" title="{!$Label.BMCServiceDesk__SavedSuccessfully}" value="/s.gif" alt="{!$Label.BMCServiceDesk__SavedSuccessfully}" />
								</td>
								<td>
									<div id="SaveMessage" style="margin-left: 6px;"><apex:outputText value="{!$Label.BMCServiceDesk__SavedSuccessfully}" /></div>
								</td>
							</tr>
						</table>
					</div>	      
                    <script> 
                        window.scroll(0,0);
                    </script>          
                </apex:outputPanel> 
                <div id='autocompleteDiv' class="clsAutocompleteDiv">
                     <select id="selectAutoOptions" class="clsAutocompleteSelectOption" onmousedown="isAutocomplete = true;"  onclick="SelectAutoValue(this,'autocompleteDiv');" multiple="multiple"  >
                     </select>
                 </div>
                  <apex:pageBlock id="thePAgeBlock" title="" >
                           <table style="overflow:none;height:100%;width:100%" cellspacing="0" cellpadding="0">
                               <tr>
                               		<td><div id="messageSpace" class="message_space_on"></div></td>
                                  <apex:facet name="header">   
                                   	<div id="topmenu" align="center" style="height:auto;width:100%;padding-bottom:5px;"></div>
                                  </apex:facet>   
                                </tr> 
                                <tr>
                                <td >
                                    <div   style="width:100%; overflow: auto;">
                                        <apex:repeat value="{!lstOfFSWrapper}" var="fsWrapper"> 
                                         <div id="div{!$Component.pageSectionId}" style="height:0px; position:relative; top:-30px">
                                        	<script>
                                                pageSectionIdMap['{!JSINHTMLENCODE(fsWrapper.fsLabel)}'] = '{!$Component.pageSectionId}';
                                            </script>
                                         </div>
                                          <apex:pageBlockSection id="pageSectionId" title="{!fsWrapper.fsLabel}" columns="{!columnSize}">
                                              <apex:repeat value="{!fsWrapper.lstOfFSMember}" var="f">
                                                  <apex:pageblockSectionItem rendered="{!$ObjectType.BMCServiceDesk__Change_Request__c.fields[f.fieldPath].Accessible}">  
                                                    <apex:outputLabel value="{!f.label}" rendered="{!NOT(CONTAINS(f.Label,'<BLANK>'))}"/>
                                                            <apex:outputPanel rendered="{!NOT(CONTAINS(f.Label,'<BLANK>'))}">
                                                                    <table id="tableId{!f.type}"  cellspacing="0" cellpadding="0">
                                                                        <tr>
                                                                            <td>
                                                                                <apex:outputPanel styleClass="editable{!$ObjectType.BMCServiceDesk__Change_Request__c.fields[f.fieldPath].updateable}">
                                                                                    <apex:inputField id="inputField" value="{!changeRequest[f.fieldPath]}" styleClass="{!If(f.type == 'reference', 'RFlookupClass', '')}" required="{!OR(f.required, f.DBRequired)}" onkeyup="setFieldAPIName('{!f.fieldPath}');" onclick="setFieldAPIName('{!f.fieldPath}');"  onblur="!IF(OR(f.required, f.DBRequired, f.type=='reference'), IF(f.type=='reference', 'disableDiv(typeAheadDivId, refType, this)', 'disableDiv(typeAheadDivId, noRefType, this)'), '')}"/>
                                                                                    <script>
                                                                                        setFSFieldDetail('{!f.fieldPath}', '{!JSENCODE(f.Label)}','{!JSENCODE(f.type)}', {!f.required}, {!f.DBRequired}, '{!JSENCODE(fsWrapper.fsName)}', '{!$Component.inputField}', '{!JSENCODE($ObjectType.Change_Request__c.fields[f.fieldPath].inlineHelpText)}', '{!$ObjectType.Change_Request__c.fields[f.fieldPath].ReferenceTo}', {!$ObjectType.Change_Request__c.fields[f.fieldPath].updateable});
                                                                                        
                                                                                    </script>
                                                                                </apex:outputPanel>                                     
                                                                            </td>
                                                                        </tr> 
                                                                    </table> 
                                                            </apex:outputPanel>
                                                  </apex:pageblockSectionItem>   
                                              </apex:repeat>
                                         </apex:pageBlockSection>
                                        </apex:repeat>
                                         <div id="section2" style="display: none">
                                         <apex:pageBlockSection id="sec5" title="{!JSENCODE($Label.BMCServiceDesk__Console_Assignment)}" columns="{!columnSize}" > 
                                           <apex:pageBlockSectionItem id="pageblock5Item1" >
                                                      <apex:outputLabel value="{!if((enableQueueAndUserAssignment),JSENCODE($Label.BMCServiceDesk__Queue),JSENCODE($Label.BMCServiceDesk__ConsoleOwner))}" />
                                                       <apex:outputPanel >
                                                             <table cellspacing="0" cellpadding="0">
                                                                 <tr>
                                                                     <td>
																			<apex:outputPanel rendered="{!NOT(enableQueueAndUserAssignment)}">
																				<input type="text" value="{!ownerName}" 
                                                                                title = "{!$ObjectType.Change_Request__c.fields.ownerid.inlineHelpText}" id="owner_Name"  readonly="readonly" disabled="disabled"/>
																			</apex:outputPanel>		
                                                                            <apex:outputPanel rendered="{!AND(($ObjectType.BMCServiceDesk__Change_Request__c.fields.BMCServiceDesk__FKStaff__c.updateable),enableQueueAndUserAssignment)}">
                                                                                <input type="text" value="{!queueName}"  
                                                                                 title = "{!$ObjectType.Change_Request__c.fields.ownerid.inlineHelpText}" id="owner_Name" class="RFlookupClass" onclick="setFieldAPIName('Owner');"/>
																			</apex:outputPanel>
                                                                            <apex:outputPanel rendered="{!AND(NOT($ObjectType.BMCServiceDesk__Change_Request__c.fields.BMCServiceDesk__FKStaff__c.updateable),enableQueueAndUserAssignment)}" style="margin-top:2%;display: block;">
                                                                               <apex:outputLabel id="owner_Name1" value="{!queueName}"/>
                                                                            </apex:outputPanel> 
																		
                                                                     </td>
                                                                     <td >
                                                                        <apex:outputPanel rendered="{!$ObjectType.BMCServiceDesk__Change_Request__c.fields.BMCServiceDesk__FKStaff__c.updateable}">
                                                                         <apex:outputPanel rendered="{!NOT(enableQueueAndUserAssignment)}">  
                                                                         <img class="closeIconDis" src="/s.gif" title="{!$Label.Clear}" alt="Clear" onclick="resetQueueText();return false;" 
                                                                     		onmouseout="this.className='closeIconDis'"  onmouseover="this.className='closeIconEnable'; " style="cursor: pointer;"/>
                                                                           </apex:outputPanel>  
                                                                            <a href="#" style="text-decoration: none;" onclick="setFieldAPIName('ownerid');openOwnerLookupPopUP(enableQueueAndUserAssignment?'QUEUE':'OWNER','','', 'Change_Request__c', changeReqId);return false;"><img class="lookupIcon" title="{!if((enableQueueAndUserAssignment),JSENCODE($Label.Queue),$ObjectType.Change_Request__c.fields.ownerid.label)} {!JSENCODE($Label.tooltipForLookup)}" 
                                                                             onmouseover="this.className = 'lookupIconOn';this.className = 'lookupIconOn';" 
                                                                                onmouseout="this.className = 'lookupIcon';this.className = 'lookupIcon';" 
                                                                                onfocus="this.className = 'lookupIconOn';" onblur="this.className = 'lookupIcon';" alt="{!if((enableQueueAndUserAssignment),JSENCODE($Label.Queue),$ObjectType.Change_Request__c.fields.FKStaff__c.label)} {!JSENCODE($Label.tooltipForLookup)}" src="/s.gif" style="cursor: pointer;" /></a>
                                                                            </apex:outputPanel>
                                                                       </td>
                                                                 </tr>
                                                             </table> 
                                                         </apex:outputPanel>
                                                 </apex:pageBlockSectionItem>    
                                                 <apex:pageBlockSectionItem id="pageblock5Item2" rendered="{!enableQueueAndUserAssignment}">
                                                      <apex:outputLabel value="{!JSENCODE($Label.BMCServiceDesk__IncidentsStaff)}" />
                                                       <apex:outputPanel >
                                                             <table cellspacing="0" cellpadding="0">
                                                                 <tr>
                                                                     <td> 
                                                                   <apex:outputPanel rendered="{!$ObjectType.BMCServiceDesk__Change_Request__c.fields.BMCServiceDesk__FKStaff__c.updateable}">
                                                                         <apex:inputText id="staffId" value="{!staffName}"
                                                                         	title="{!$ObjectType.BMCServiceDesk__Change_Request__c.fields.BMCServiceDesk__FKStaff__c.inlineHelpText}" styleClass="RFlookupClass" onclick="setFieldAPIName('BMCServiceDesk__FKStaff__c')"/>
                                                                    </apex:outputPanel>
                                                                     <apex:outputPanel rendered="{!NOT($ObjectType.BMCServiceDesk__Change_Request__c.fields.BMCServiceDesk__FKStaff__c.updateable)}" style="margin-top:3%;display: block;">
                                                                         <apex:outputLabel id="staffId1" value="{!staffName}"/>
                                                                     </apex:outputPanel>  
                                                            
                                                                     </td>
                                                                     <td >
                                                                            <apex:outputPanel rendered="{!$ObjectType.BMCServiceDesk__Change_Request__c.fields.BMCServiceDesk__FKStaff__c.updateable}">
                                                                            <apex:outputPanel rendered="{!NOT(enableQueueAndUserAssignment)}">  
                                                                            <img class="closeIconDis" src="/s.gif" title="{!JSENCODE($Label.Clear)}" alt="Clear" onclick="resetStaffText();return false;" 
                                                                     		onmouseout="this.className='closeIconDis'"  onmouseover="this.className='{!IF(enableQueueAndUserAssignment == true,'closeIconEnable','closeIconDis')}'" style="cursor: pointer;"/>
                                                                            </apex:outputPanel> 
                                                                         <a href="#" style="text-decoration: none;" onclick="setFieldAPIName('FKStaff__c');openOwnerLookupPopUP('STAFF',queueId,'', 'Change_Request__c', changeReqId);return false;"><img class="lookupIcon" title="{!$ObjectType.Change_Request__c.fields.FKStaff__c.label} {!JSENCODE($Label.tooltipForLookup)}" 
                                                                             onmouseover="this.className = 'lookupIconOn';this.className = 'lookupIconOn';" 
                                                                                onmouseout="this.className = 'lookupIcon';this.className = 'lookupIcon';" 
                                                                             onfocus="this.className = 'lookupIconOn';" onblur="this.className = 'lookupIcon';" alt="{!$ObjectType.Change_Request__c.fields.FKStaff__c.label} {!JSENCODE($Label.tooltipForLookup)}" src="/s.gif" style="cursor: pointer;" /></a>
                                                                            </apex:outputPanel>
                                                                       </td>
                                                                 </tr>
                                                             </table> 
                                                         </apex:outputPanel>
                                                 </apex:pageBlockSectionItem>                                
                                      </apex:pageBlockSection>
                                     </div>
                                     </div>
                                </td>
                            </tr>
                          </table> 
						   <apex:facet name="footer">
						<table style="border: 1;" align="Center" cellspacing="0" cellpadding="0">
							<tr>
                                <td align="center"><span><a class="backtotop" href="#" onClick="if(parent.isServiceCloudConsole == 'true') {parent.scrollTo(0,0);}">{!$Label.Console_BackToTop}</a> </span> 
								<span id="links" style="display: {!IF(changeRequest.Id == '', 'none', 'inline')}">
								<span class="separator"> | </span> 
								<span><a class="backtotop" id="RelatedListlink" href="javascript:void(0)" onClick="window.parent.ChangeRelatedListBtnhandler();">{!$Label.RelatedLists}</a></span>
								 </span> 
								</td>
							</tr>
						</table>
					</apex:facet>
                    </apex:pageBlock> 
					<apex:inputHidden value="{!changeRequest.BMCServiceDesk__FKUrgency__c}" id="urgency__id"/>
                    <apex:inputHidden value="{!changeRequest.BMCServiceDesk__FKImpact__c}" id="impact__id"/>
                    <apex:inputHidden value="{!changeRequest.BMCServiceDesk__FKStatus__c}" id="status__id"/> 
					<apex:inputHidden value="{!changeRequest.BMCServiceDesk__FKInitiator__c}" id="User__id"/>

                    <apex:inputHidden value="{!changerequest.BMCServiceDesk__FKStaff__c}" id="ownerOpenby_Id"/>
                    <apex:inputHidden value="{!changerequest.ownerid}" id="owner_Id"/>
                    <apex:inputHidden value="{!queueId}" id="queueId"/>
                    <script>
						urgencyLookupId = '{!$Component.urgency__id}';
                        impactLookupId = '{!$Component.impact__id}';
                        statusLookupId = '{!$Component.status__id}';
                        queue_Id = '{!$Component.queueId}';
                        
						userId = '{!$Component.User__id}';
						var catName = '{!categoryName}';
                        var staffName = '{!JSENCODE(staffName)}';
                        var ownerName = '{!JSENCODE(ownerName)}';
                        var queueName = '{!JSENCODE(queueName)}';
                        var queueId = '{!JSENCODE(queueId)}';

                        var urgancyvalue='{!changeRequest.BMCServiceDesk__FKUrgency__c}';
                        var impactvalue='{!changeRequest.BMCServiceDesk__FKImpact__c}';
                        var statusvalue='{!changeRequest.BMCServiceDesk__FKStatus__c}';
                        var UserIdvalue='{!changeRequest.BMCServiceDesk__FKInitiator__c}';
                        

                        var enableQueueAndUserAssignment = {!enableQueueAndUserAssignment};
                        var ownerOpenById = '{!$Component.ownerOpenby_Id}';
                        var ownerId = '{!$Component.owner_Id}';
                        var  staffId = '{!$Component.thpage:theForm:thePAgeBlock:sec5.pageblock5Item2.staffId}';
        				var  strQueueId = '{!$Component.queueId}';
        				 
                        document.getElementById(ownerOpenById).value = '{!changeRequest.FKStaff__c}';
                        document.getElementById(ownerId).value = '{!changeRequest.ownerid}';
                    </script>           
                </apex:outputPanel>
    </apex:form>
    <script>
    	var errorComponentID = '{!$Component.thpage:theForm:pageMessage}';
        var prefixMap;
        if(window.parent.isRFConsoleDetailForm =='true'){
            prefixMap = window.parent.parent.ObjectPrefixMap;
        }else{
            prefixMap = window.parent.ObjectPrefixMap;
        }
        prefixMap.push(new Array('005','User'));
        prefixMap.push(new Array('00G','Group'));
        
        var selectInitiatorId=0;
        var OverwriteWarning = '{!JSENCODE($Label.OverwriteWarning)}';
        var TemplateValidationError = '{!JSENCODE($Label.TemplateValidationError)}';
        var applytemplateToExistingRecord = '{!JSENCODE(applytemplateToExistingRecord)}';
		var overrideRecWithTemplateVal = '{!JSENCODE(overrideRecWithTemplateVal)}';
		var CrClosed = '{!JSENCODE($Label.CrClosed)}';
        var saveSuccess = '{!JSENCODE($Label.SavedSuccessfully)}';
        var searchErrorMsg = '{!JSENCODE($Label.GsErrorMsg)}';
        var enableQueueAndUserAssignment = {!enableQueueAndUserAssignment};
        var ownerType ='';
        var isRTFEnabled = true; 
        var initiatorId = '{!JSENCODE(changeRequest.FKInitiator__c)}';
        var mandatoryFieldValueValidationMsg = '{!JSENCODE($Label.mandatoryFieldValueValidationMsg)}';
        var columnSize = {!columnSize};
        var changeReqId = '{!JSENCODE(changeRequest.Id)}';
        var selectedCatId = '{!JSENCODE(changeRequest.FKCategory__c)}';
        var status = '{!changeRequest.State__c}';
		var Ok='{!JSENCODE($Label.Ok)}';
		var Cancel='{!JSENCODE($Label.Cancel)}';
        
        _RemotingActions={}
       	_RemotingActions.clientAutoData = '{!$RemoteAction.ConsoleRemoteActions.clientAutoData}';
        _RemotingActions.fetchAutoSelectData= '{!$RemoteAction.ConsoleRemoteActions.fetchAutoSelectData}';
        _RemotingActions.getLookUpData = '{!$RemoteAction.ConsoleRemoteActions.getData}';
     	_RemotingActions.checkChangeRequestForBlackoutOverlap = '{!$RemoteAction.ConsoleRemoteActions.checkChangeRequestForBlackoutOverlap}';
   
   
        var setChangeData ;
        var saveChangeRequest = function doSave(){ 
            var errorMsges = validateData();
    		if (errorMsges!='') {
    			document.getElementById('messageSpace').className='message_space_off';
    			return showPageMsg(errorMsges);
			}
			document.getElementById('messageSpace').className='message_space_off';
            var strQueueName = '';
        	if (document.getElementById(getHTMLInputID('OwnerId'))) 
                strQueueName = document.getElementById(getHTMLInputID('OwnerId')).value;
            else if (document.getElementById('owner_Name'))
                strQueueName = document.getElementById('owner_Name').value;         
             
             var scheduledStartDate='';
             var scheduledEndDate='';
             if(document.getElementById(getHTMLInputID(orgNamespace + 'Scheduled_Start_Date__c'))){
             	scheduledStartDate =document.getElementById(getHTMLInputID(orgNamespace + 'Scheduled_Start_Date__c')).value ;
             }
             if(document.getElementById(getHTMLInputID(orgNamespace + 'Scheduled_End_Date__c'))){
             	scheduledEndDate = document.getElementById(getHTMLInputID(orgNamespace + 'Scheduled_End_Date__c')).value;
             }
	         var canScheduleCRandBlackOutDuringOverlap = {!canScheduleCRandBlackOutDuringOverlap};
			Visualforce.remoting.Manager.invokeAction(_RemotingActions.checkChangeRequestForBlackoutOverlap,
			scheduledStartDate,
			scheduledEndDate,
			function(result, event) {
				if(event.status){  
					if(result!= null && result!= ''){
						if(result.isBlackoutOverlap == 'true'){
							//CR is scheduled in blackout period
						 if(canScheduleCRandBlackOutDuringOverlap == true){
							var message = '{!JSINHTMLENCODE($Label.NewCRwithBlackoutOverlapMessage1)}';
							message = message.replace(/\\n/g, '<br/>');
							message = message + ' <a href="#" onclick="loadChangeschPage(\'standardLayout=true&isFromCRPage=true&ClientDate='+result.ClientDate+'\')">{!JSINHTMLENCODE($Label.ClickHere)}</a>.<br/><br/>{!JSINHTMLENCODE($Label.NewCRwithBlackoutOverlapMessage2)}';
							var Ext = parent.Ext;
							Ext.Msg.show({
								msg: message,
								buttons: Ext.Msg.OKCANCEL,
								 buttonText : {
									ok : Ok,
									cancel : Cancel
								},
								fn:  function(btn){							
									if(btn == 'ok'){
										startWaitMsgBar();
										if(window.parent.RTFEnabledPage())
											saveSuccessful = save(strQueueName, window.parent.lastModifiedByLocking);
										else{
											retainStaticFieldValueBeforeTemplateApply();
											saveSuccessful = saveWithRerender(strQueueName,queueId, window.parent.lastModifiedByLocking);
										}
									}
									else{
										return;
									}							
								},
								icon: Ext.MessageBox.WARNING
							});
							
							
						}else{
							startWaitMsgBar();
	
						if(window.parent.RTFEnabledPage())
							save(strQueueName);
						else{
							retainStaticFieldValueBeforeTemplateApply();
							saveWithRerender(strQueueName,queueId);
						}
						}	
						
					}else{
						//CR is not scheduled in blackout period
						startWaitMsgBar();
	
						if(window.parent.RTFEnabledPage())
							save(strQueueName);
						else{
							retainStaticFieldValueBeforeTemplateApply();
							saveWithRerender(strQueueName,queueId);
						}
						
					}
				} 
		}
		},{escape: false});  
        }
     
      if(window.parent.saveChange!=undefined){
            window.parent.saveChange(saveChangeRequest);
        }
      
       if(window.parent.showCollisionMessagePar!=undefined){            
            window.parent.showCollisionMessagePar(rerenderCollisionMessage);           
        }                
    </script>
       <apex:outputPanel id="renderPanel">             
        <script>         
           
           status = '{!changeRequest.State__c}';
           changeReqId = '{!JSENCODE(changeRequest.Id)}';
           initiatorId = '{!JSENCODE(changeRequest.FKInitiator__c)}';
           callback={!callback};
            var queueId = '{!JSENCODE(queueId)}';
           setChangeData = function setChangeData(){
           
                var arr = new Array();
                arr['Id'] = '{!JSENCODE(changeRequest.Id)}';
                arr['Name'] = '{!JSENCODE(changeRequest.Name)}';
                arr[ 'FKCategory__c' ] = '{!JSENCODE(changeRequest.FKCategory__c)}';
                arr[ 'FKInitiator__c' ] = '{!JSENCODE(changeRequest.FKInitiator__c)}';
                arr[ 'Stage__c' ] = getTranslatedStage();
                arr[ 'state__c' ] =  '{!changeRequest.State__c}';
                arr[ 'id' ] =  '{!changeRequest.id}';
                arr[ 'ServiceTargetStatus' ]='{!JSENCODE(ServiceTargetStatus)}';
                arr[ 'changeDescription__c' ] =  '{!JSENCODE(changeRequest.Change_Description__c)}';
                arr[ 'isRecordLock' ] = '{!JSENCODE(isRecordLock)}';                 
                return arr;
            
            };
        if(window.parent.setChangeData!=undefined){
            window.parent.setChangeData(setChangeData);
        } 
        
         function getTranslatedStage(){  
            
            if('{!JSENCODE(changeRequest.FKStatus__r.Stage__c)}' =='Opened'){
                return '{!JSENCODE($Label.Opened)}';
            }else if('{!JSENCODE(changeRequest.FKStatus__r.Stage__c)}' =='Acknowledged'){
                return '{!JSENCODE($Label.StageProgression_Acknowledged)}';
            }else if('{!JSENCODE(changeRequest.FKStatus__r.Stage__c)}' =='In Process'){
                return '{!JSENCODE($Label.StageProgression_InProcess)}';
            }else if('{!JSENCODE(changeRequest.FKStatus__r.Stage__c)}' =='Closed'){
                return '{!JSENCODE($Label.Closed)}';
            }else{
                return '{!JSENCODE(changeRequest.FKStatus__r.Stage__c)}';
            }
         }
        
        
        </script>   
        </apex:outputPanel>    
    <apex:outputPanel id="genericPanel">             
        <script>         
           var messageStr  = '{!JSENCODE(messageString)}';
          
           function displayMessage(){
                if(!isRTFEnabled && messageStr!=null && messageStr !=''){
                    if(messageStr == saveSuccess){
                        window.parent.afterSaveSucceed();
						handleElemEvent();
                        ShowInlineSaveMessage();
                    }else{
                        alert(messageStr);
                    }
                } else if(messageStr ==null || messageStr == '') {
            		var clickedOnceTemp = window.parent.clickedOnce ;
            		handleElemEvent();
            		window.parent.clickedOnce = clickedOnceTemp ;
            	}
            }
            
              
        </script>   
   </apex:outputPanel>
   

    <script type="text/javascript" src="{!$Resource.SDEFCommonJS}/HTML_ENCODE_DECODE.js"></script>
    <script src="{!$Resource.SDEFCommonJS}/ConsoleChangeDetails.js"  type="text/javascript" />
    <script src="{!$Resource.SDEFCommonJS}/TypeAhead.js"  type="text/javascript" />
	<script src="{!$Resource.SDEFCommonJS}/ConsoleDetail.js"  type="text/javascript" />
    <apex:outputPanel id="frequentRereshPanel">
        <script>
			clientName = '{!JSENCODE(initiatorName)}';
			showClientAsRequired(orgNamespace+'FKInitiator__c',isClientMandatory);
			userTypeReference ='{!JSENCODE(userTypeReference)}';
            if(userTypeReference !=null && userTypeReference != 'undefined' && userTypeReference!='')
            	hideUserTypeSelector(userTypeReference);   
        	hideClientTypeSelector(orgNamespace+'FKInitiator__c');
        	showCategoryAsRequired(orgNamespace+'FKCategory__c',isCategoryMandatory);
            unableDisableTemplateField(changeReqId);
            createUrgencyPickList('{!$ObjectType.Change_Request__c.fields.FKUrgency__c.Updateable}');
            createImpactPickList('{!$ObjectType.Change_Request__c.fields.FKImpact__c.Updateable}');
            createStatusPickList('changeRequest', '{!$ObjectType.Change_Request__c.fields.FKStatus__c.Updateable}');   
            createSectionLinks();
			adjustFSLinkDiv();
            setTypeAheadForLookups();
            createStandardOwnerField('Change_Request__c', changeReqId);
			createStandardStaffField('Change_Request__c', changeReqId);
        </script>
    </apex:outputPanel>
    <script>    
        handleElemEvent();
		createFilterFieldMap();
		if(firstElement != null && firstElement != '')
			document.getElementById(firstElement).focus();
			
		if(document.addEventListener){
            document.addEventListener("click", function(){
                if(isAutocomplete != 'undefined' && isAutocomplete != undefined && isAutocomplete){
                    disableAutoDiv();
                }
            });
        }else if(document.attachEvent){
            document.attachEvent("onclick", function(){
                if(isAutocomplete != 'undefined' && isAutocomplete != undefined && isAutocomplete){
                    disableAutoDiv();
                }
            });
        }
		
    </script> 
  </body>
</apex:page>