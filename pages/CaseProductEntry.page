<apex:page standardController="Case" extensions="CaseProductEntryExtension" sidebar="false" action="{!init}" title="{!$ObjectType.Product2.LabelPlural} for {!$ObjectType.Case.Label}: {!Case.CaseNumber} {!Case.Subject}">
    <apex:includeScript value="/support/console/33.0/integration.js"/>
    <script>
    sforce.console.setTabTitle('{!$ObjectType.Product2.LabelPlural} for {!Case.Subject}');
    </script>
    <apex:sectionHeader Title="Manage {!searchTypeText}" subtitle="{!Case.CaseNumber} {!Case.Subject}"/>
    <apex:form id="form">
        <apex:pageMessages id="msgs"/>
        <apex:outputPanel rendered="{!backToCase}">
            <script>
            if (sforce.console.isInConsole()) {
                sforce.console.getEnclosingPrimaryTabId(function(result) {
                    var primaryTabId = result.id;
                    sforce.console.refreshPrimaryTabById(primaryTabId, true, function(result) {
                        sforce.console.getEnclosingTabId(function(result) {
                            sforce.console.closeTab(result.id);
                        });
                    });
                });
            } else {
                location = "/{!Case.Id}";
            }
            </script>
        </apex:outputPanel>
        <apex:outputPanel rendered="{!!backToCase}">
            <apex:pageBlock mode="mainDetail">
                <apex:pageBlockSection >
                    <apex:outputField value="{!Case.RecordTypeId}"/>
                </apex:pageBlockSection>
            </apex:pageBlock>
            <apex:pageBlock title="Selected {!searchTypeText}" id="selected">
                <apex:pageBlockButtons >
                    <apex:commandButton action="{!onSave}" value="Save" rerender="form"/>
                    <apex:commandButton action="{!cancel}" value="Cancel" immediate="true" rendered="{!$CurrentPage.parameters.isdtp!='vw'}"/>
                </apex:pageBlockButtons>
                <apex:pageblockTable value="{!shoppingCart}" var="s">                   
                    <apex:column >
                        <apex:commandLink value="Remove" action="{!removeFromShoppingCart}" reRender="form">
                            <apex:param value="{!s.Product__c}" assignTo="{!toUnselect}" name="toUnselect"/>
                        </apex:commandLink>
                    </apex:column>
                    <apex:column headerValue="{!$ObjectType.Product2.Label}" value="{!s.Product__r.Name}"/>
                    <apex:column headerValue="{!$ObjectType.Product2.Fields.Business_Unit__c.Label}" value="{!s.Product__r.Business_Unit__c}"/>
                    <apex:column headerValue="{!$ObjectType.Product2.Fields.ProductCode.Label}" value="{!s.Product__r.ProductCode}"/>
                    <apex:column headerValue="{!$ObjectType.Case_Product__c.Fields.Quantity__c.Label}">
                        <apex:inputField value="{!s.Quantity__c}" style="width:70px"/>
                    </apex:column>
                    <apex:column headerValue="{!$ObjectType.Case_Product__c.Fields.Serial_Number__c.Label}">
                        <apex:inputField value="{!s.Serial_Number__c}" style="width:70px"/>
                    </apex:column>
                </apex:pageblockTable>
            </apex:pageBlock>
            <apex:pageBlock title="Search for {!searchTypeText}">
                <apex:pageBlockSection >
                    <apex:pageBlockSectionItem >
                        <apex:outputLabel value="{!$Label.Danfoss_segment}" for="divisionvalues"></apex:outputLabel>
                        <apex:selectList value="{!Division}" size="1" id="divisionvalues" rendered="true" style="width:175px">
                            <apex:actionSupport event="onchange" reRender="msgs, PLvalues" status="searchStatus" />
                            <apex:selectOptions value="{!Divisions}"/>                               
                        </apex:selectList>
                    </apex:pageBlockSectionItem>
                    <apex:pageBlockSectionItem >
                        <apex:outputLabel value="{!$ObjectType.Product2.Fields.Business_Unit__c.Label}" for="PLvalues"></apex:outputLabel>
                        <apex:selectList value="{!ProductLine}" size="1" id="PLvalues" rendered="true" style="width:175px">
                            <apex:selectOptions value="{!ProductLines}"/>                               
                        </apex:selectList>
                    </apex:pageBlockSectionItem>
                    <apex:pageBlockSectionItem >
                        <apex:outputLabel value="{!$ObjectType.Product2.Fields.Name.Label}" for="ProductDesc"></apex:outputLabel>
                        <apex:inputText id="ProductDesc" value="{!searchString}" style="width:170px" rendered="true"/>
                    </apex:pageBlockSectionItem>
                    <apex:pageBlockSectionItem >
                        <apex:outputLabel value="{!$ObjectType.Product2.Fields.Product_Line__c.Label}" for="ProductClass"></apex:outputLabel>
                        <apex:inputText id="ProductClass" value="{!searchClass}" style="width:170px" rendered="true"/>
                    </apex:pageBlockSectionItem>
                    <apex:pageBlockSectionItem >
                        <apex:outputLabel value="{!$ObjectType.Product2.Fields.Product_Set__c.Label}" for="ProductStat"></apex:outputLabel>
                        <apex:inputText id="ProductStat" value="{!searchStatNo}" style="width:170px" rendered="true"/>  
                    </apex:pageBlockSectionItem>
                    <apex:pageBlockSectionItem >
                        <apex:outputLabel value="{!$ObjectType.Product2.Fields.ProductCode.Label}" for="ProductCode"></apex:outputLabel>
                        <apex:inputText id="ProductCode" value="{!searchMaterialNo}" style="width:170px" rendered="true"/>        
                    </apex:pageBlockSectionItem>
                    <apex:pageBlockSectionItem >
                    </apex:pageBlockSectionItem>
                </apex:pageBlockSection>
                <apex:pageBlockSection columns="1">
                    <apex:outputPanel style="text-align:center" layout="block">             
                        <apex:commandButton value="Search" action="{!search}" reRender="msgs, searchResults" status="searchStatus"/>                                                    
                        <div>
                            <i>
                                <apex:actionStatus id="searchStatus" startText="searching..." stopText=" "/>
                            </i>
                        </div>
                    </apex:outputPanel> 
                </apex:pageBlockSection>
                <apex:outputPanel id="searchResults">
                    <apex:outputPanel rendered="{!AvailableProductsCon != null}">
                        <apex:pageBlockTable value="{!AvailableProducts}" var="a">
                            <apex:column >
                                <apex:commandButton value="Select" action="{!addToShoppingCart}" reRender="form">
                                    <apex:param value="{!a.Id}" assignTo="{!toSelect}" name="toSelect"/>
                                </apex:commandButton>
                            </apex:column>
                            <apex:column headerValue="{!$ObjectType.Product2.Fields.Name.Label}" value="{!a.Name}" />
                            <apex:column headerValue="{!$ObjectType.Product2.Fields.Business_Unit__c.Label}" value="{!a.Business_Unit__c}"/>
                            <apex:column headerValue="{!$ObjectType.Product2.Fields.Product_Line__c.Label}" value="{!a.Product_Line__c}"/>
                            <apex:column headerValue="{!$ObjectType.Product2.Fields.Product_Set__c.Label}" value="{!a.Product_Set__c}"/>
                            <apex:column headerValue="{!$ObjectType.Product2.Fields.ProductCode.Label}" value="{!a.ProductCode}" />                        
                        </apex:pageBlockTable>
                        <c:PrevNextLinks setCon="{!AvailableProductsCon}" rerender="msgs, searchResults" status="searchStatus"/>
                        <c:PageNumber setCon="{!AvailableProductsCon}"/>
                        <apex:pageMessage severity="info" strength="1" rendered="{!AvailableProducts.Empty}" summary="Your search returned no results for products."/>
                    </apex:outputPanel>
                </apex:outputPanel>
            </apex:pageBlock>
        </apex:outputPanel>
    </apex:form>
</apex:page>