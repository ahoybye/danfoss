<apex:page standardController="Opportunity" extensions="SearchOpportunityExtension">
    <apex:form id="form" onsubmit="return checkDoubleSubmit(this)">
        <script>
            function disableInput(input) {
                var btn = input;
                setTimeout(function(){ 
                    btn.disabled = 'disabled';
                    // Use the Salesforce CSS style to make the button appear disabled
                    btn.className = 'btnDisabled';
                    btn.value = "Saving..."; 
                }, 50);
            }
        	var isSubmited = false; 
        	function checkDoubleSubmit(obj)
        	{ 
                if (isSubmited) { 
                    return false; 
                }else { 
                    isSubmited = true;                     
                    return true; 
                } 
            } 
        
        </script>
        <apex:pageMessages />
        <apex:pageBlock mode="edit" title="Create Opportunity" rendered="{!contactsCon = null && AvailableSalesAreas = null}">
            <apex:pageBlockButtons >
                <apex:commandButton action="{!cancel}" value="Cancel"/>
            </apex:pageBlockButtons>
            <apex:pageBlockSection columns="1">
                <apex:inputField value="{!Opportunity.Name}"/>
                <apex:inputField required="true" value="{!Opportunity.AccountId}"/>
                 <apex:pageBlockSectionItem helpText="Use to link more Opportunities together - for example for cross divisional projects" LabelTitle="Project Umbrella (Multiple Opportunities)">
                    <apex:outputLabel value="Project Umbrella (Multiple Opportunities)" for="outputpanelProject" rendered="true" />
                    <apex:outputpanel id="outputpanelProject">
                        <apex:inputCheckbox label="Project" id="isProjectOpp" value="{!isProjectOpp}"/>
                        <apex:actionSupport event="onclick" action="{!showProjectFields}" rerender="form" status="counterStatus"/>
                    </apex:outputpanel>
                </apex:pageBlockSectionItem>
                <apex:pageBlockSectionItem helpText="Add the name of the already existing project." rendered="{!isProjectOpp}">
                    <apex:outputLabel value="Existing Project" for="ExistingProject"/>
                    <apex:inputfield value="{!opportunity.Project_Opportunity__c}" id="ProjectOpp"/>
                </apex:pageBlockSectionItem>
                <apex:pageBlockSectionItem helpText="Add the name of the project. Reuse the Opportunity Name." rendered="{!isProjectOpp}">
                    <apex:outputLabel value="New Project " for="NewProject"/>
                    <apex:inputText value="{!newProject}" id="NewProject"/>
                </apex:pageBlockSectionItem>
                <apex:pageBlockSectionItem >
                    <apex:outputLabel />
                    <apex:outputPanel >
                        <apex:commandButton value="Next" action="{!search}" rendered="{!!createpossible}" rerender="form,opplists" status="createOppStatus"/>
                        <apex:commandButton value="Next" action="{!createNew}" rendered="{!createpossible}" rerender="form,opplists" status="createOppStatus"/>
                        <apex:outputPanel style="color:#4AA02C;font-weight:bold">
                            <apex:actionStatus id="createOppStatus" startText="Loading..."/>
                        </apex:outputPanel>
                    </apex:outputPanel>
                </apex:pageBlockSectionItem>
            </apex:pageBlockSection>
            <apex:pageBlockSection title="Related Opportunities..." columns="1" rendered="{!setCon != null}">
                <apex:pageBlockTable value="{!results}" var="a" >
                    <apex:column value="{!a.Name}"/>
                    <apex:column value="{!a.Account.name}"/>
                    <apex:column value="{!a.Project_Opportunity__c}" rendered="{!isProjectOpp}"/>
                    <apex:column value="{!a.Amount}"/>
                    <apex:column value="{!a.stagename}"/>
                    <apex:column value="{!a.CE_Division__c}"/>
                    <apex:column value="{!a.closedate}"/>
                    <apex:column value="{!a.City__c}"/>
                    <apex:column value="{!a.Country__c}"/>
                    <apex:column value="{!a.Owner.name}"/>                    
                    <apex:column value="{!a.id}" rendered="false"/>
                    <apex:column >
                        <apex:commandlink value="Go to Opportunity" action="{!GoToAccount}" >
                            <apex:param name="accID" value="{!a.id}" assignTo="{!selectedOpportunity}"/>
                        </apex:commandlink>
                    </apex:column>
                </apex:pageBlockTable>
                <apex:panelGrid columns="3">
                    <c:PrevNextLinks setCon="{!setCon}" rerender="form" status="fetchStatus"/>
                    <c:PageNumber setCon="{!setCon}"/>
                    <apex:outputPanel style="color:#4AA02C;font-weight:bold">
                        <apex:actionStatus id="fetchStatus" startText="Fetching..." stopText=""/>
                    </apex:outputPanel>
                </apex:panelGrid>
            </apex:pageBlockSection>
        </apex:pageBlock>
        <apex:pageBlock mode="edit" title="Create Opportunity" rendered="{!contactsCon != null && AvailableSalesAreas = null}">
            <apex:pageBlockButtons >
                <apex:commandButton action="{!cancel}" value="Cancel"/>
            </apex:pageBlockButtons>
            <apex:pageBlockSection title="Opportunity details">                
                <apex:inputField required="true" value="{!Opportunity.amount}"/>
                <apex:inputField required="true" value="{!Opportunity.CurrencyIsoCode}"/>
                <apex:inputField value="{!Opportunity.CloseDate}"/>
            </apex:pageBlockSection>
            <apex:pageBlockSection title="Select contact" columns="1">
                <apex:pageBlockTable value="{!ContactsList}" var="c">
                    <apex:column headerValue="Action">
                        <apex:commandLink action="{!selectSalesArea}" onclick="disableInput(this);" value="Create Opportunity with Contact" rerender="form" status="selectContactStatus">
                            <apex:param name="selContactId" value="{!c.Id}" assignTo="{!selectedContactId}"/>
                        </apex:commandLink>
                    </apex:column>
                    <apex:repeat value="{!$ObjectType.Contact.FieldSets.CreateOpportunityFields}" var="f">
                        <apex:column value="{!c[f]}" />
                    </apex:repeat>
                </apex:pageBlockTable>
                <apex:panelGrid columns="4">
                    <apex:commandLink action="{!selectSalesArea}" onclick="disableInput(this);" value="Create Opportunity without a Contact" rerender="form" status="selectContactStatus" style="font-weight: bold">
                        <apex:param name="selContactId" value="" assignTo="{!selectedContactId}"/>
                    </apex:commandLink>
                    <c:PrevNextLinks setCon="{!contactsCon}" rerender="form" status="selectContactStatus"/>
                    <c:PageNumber setCon="{!contactsCon}"/>
                    <apex:outputPanel style="color:#4AA02C;font-weight:bold">
                        <apex:actionStatus id="selectContactStatus" startText="Creating opportunity..."/>
                    </apex:outputPanel>
                </apex:panelGrid>
            </apex:pageBlockSection>
        </apex:pageBlock>
        <apex:pageBlock mode="edit" title="Create Opportunity" rendered="{!AvailableSalesAreas != null}">
            <apex:pageBlockButtons >
                <apex:commandButton action="{!cancel}" value="Cancel"/>
            </apex:pageBlockButtons>
            <apex:pageBlockSection columns="1">
                <apex:pageBlockTable value="{!AvailableSalesAreas}" var="sa">
                    <apex:column >
                        <apex:commandLink value="Select" action="{!createOppandProject}" onclick="disableInput(this);" reRender="form" status="saleareaStatus">
                            <apex:param name="saleareaid" assignTo="{!selectedSalesArea}" value="{!sa.Id}"/>
                        </apex:commandLink>
                    </apex:column>
                    <apex:repeat value="{!$ObjectType.Sales_Area__c.FieldSets.PricesForOpportunityColumns}" var="field">
                        <apex:column value="{!sa[field.FieldPath]}"/>
                    </apex:repeat>
                </apex:pageBlockTable>
            </apex:pageBlockSection>
            <apex:actionStatus id="saleareaStatus" startText="Loading..."/>
        </apex:pageBlock>
        <apex:outputPanel rendered="{!navigateToEditOpp}">
            Loading...
            <script>
            var oppID = '{!Opportunity.Id}';
            if (window.sforce) {
                sforce.one.editRecord(oppID);
            } else {
                location = "/" + oppID + "/e?retURL="+ oppID;
            }
            </script>
        </apex:outputPanel>
    </apex:form>
    <apex:outputPanel id="opplists">
        <apex:enhancedList type="account" listID="{!myOpportunities}" height="240" rowsPerPage="10" id="dmyaccs" rendered="{!contactsCon = null && setCon = null}"></apex:enhancedList>
        <apex:enhancedList type="account" listID="{!myTeamOpportunities}" height="240" rowsPerPage="10" id="dmyteamaccs" rendered="{!contactsCon = null && setCon = null}"></apex:enhancedList>  
    </apex:outputPanel>
</apex:page>